# OHand 通信协议

## 1. 通信协议概要

用户主控单元通过发送命令数据实现对灵巧手的状态获取和控制。
上位系统向 ROH 灵巧手发送读指令，ROH 灵巧手收到指令数据并校验成功后，将相应的结果返回给上位系统。

## 2. RS232、RS485 通讯参数

RS232、RS485 通讯参数都是 115200bps、8 数据位、1 停止位、无奇偶校验。

## 3. 灵巧手串口指令帧格式

操作 ROH 灵巧手的指令帧格式如下：

| 字节                           | 数值                     | 说明                                                |
| ------------------------------ | ------------------------ | --------------------------------------------------- |
| byte[0]                        | 0x55                     | 包头                                                |
| byte[1]                        | 0xAA                     | 包头                                                |
| byte[2]                        | HandID                   | ROH 灵巧手 ID 号                                    |
| byte[3]                        | MasterID                 | 主机 ID 号                                          |
| byte[4]                        | Command                  | 操作命令                                            |
| byte[5]                        | DataLen                  | 该帧数据部分长度，即 byte[6]..byte[6 + DataLen - 1] |
| byte[6]..byte[6 + DataLen - 1] | Data[0]..Data[DataLen-1] | 命令数据                                            |
| byte[6 + DataLen]              | Checksum                 | 校验码（参见 4. LRC 校验码计算方式）                |

ROH 灵巧手对指令的回复帧如下：

| 字节                           | 数值                       | 说明                                                                                                       |
| ------------------------------ | -------------------------- | ---------------------------------------------------------------------------------------------------------- |
| byte[0]                        | 0x55                       | 包头                                                                                                       |
| byte[1]                        | 0xAA                       | 包头                                                                                                       |
| byte[2]                        | MasterID                   | 主机 ID 号                                                                                                 |
| byte[3]                        | HandID                     | ROH 灵巧手 ID 号                                                                                           |
| byte[4]                        | Command                    | 操作命令， 如果指令执行错误，那么最高位为 1，低七位为操作命令，Data[0]为错误代码（参见 6. 灵巧手错误代码） |
| byte[5]                        | DataLen                    | 该帧数据部分长度，即 byte[6]..byte[6 + DataLen - 1]                                                        |
| byte[6]..byte[6 + DataLen - 1] | Data[0]..Data[DataLen - 1] | 返回数据                                                                                                   |
| byte[6 + DataLen]              | Checksum                   | 校验码（参见 4. LRC 校验码计算方式）                                                                       |

## 4. LRC 校验码计算方式

灵巧手串口指令帧中 byte[2]..byte[6 + DataLen - 1]的各字节异或值:

```c
uint8_t buf[...];
uint8_t lrc = 0;
uint8_t cmd_data_len = 4/* sizeof(MasterID) + sizeof(HandID) + sizeof(Command) + sizeof(DataLen) */ + DataLen;

/* Fill buf */
buf[0] = 0x55;
buf[1] = 0xAA;
...

for (int i=0; i<cmd_data_len; i++)
    lrc ^= buf[2 + i];

buf[2 + cmd_data_len] = lrc;
```

## 5. Commands

| Command Name                      | Command Value | Command Description                                               | Command Data Bytes                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Command Response Data                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :-------------------------------- | ------------: | :---------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| HAND_CMD_GET_FW_VERSION           |          0x01 | Get firmware version                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FW_REVISION_L, FW_REVISION_H, FW_MINOR_VERSION, FW_MAJOR_VERSION]                                                                                                                                                                                                                                                                                                                                                                                                     |
| HAND_CMD_GET_HW_VERSION           |          0x02 | Get firmware version                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [HW_TYPE, HW_VER, BOOT_VER_MAJOR, BOOT_VER_MINOR]                                                                                                                                                                                                                                                                                                                                                                                                                      |
| HAND_CMD_GET_CALI_DATA            |          0x03 | Get calibration data                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [F0_RANGE_END_L, F0_RANGE_END_H, F1_RANGE_END_L, F1_RANGE_END_H, F2_RANGE_END_L, F2_RANGE_END_H, F3_RANGE_END_L, F3_RANGE_END_H, F4_RANGE_END_L, F4_RANGE_END_H, F0_RANGE_START_L, F0_RANGE_START_H, F1_RANGE_START_L, F1_RANGE_START_H, F2_RANGE_START_L, F2_RANGE_START_H, F3_RANGE_START_L, F3_RANGE_START_H, F4_RANGE_START_L, F4_RANGE_START_H, THUMB_ROOT_POS1_L, THUMB_ROOT_POS1_H, THUMB_ROOT_POS2_L, THUMB_ROOT_POS2_H, THUMB_ROOT_POS3_L, THUMB_ROOT_POS3_H] |
| HAND_CMD_GET_FINGER_PID           |          0x04 | Get PID value of finger, PID values are all in float32            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, P_BYTE0, P_BYTE1, P_BYTE2, P_BYTE3, I_BYTE0, I_BYTE1, I_BYTE2, I_BYTE3, D_BYTE0, D_BYTE1, D_BYTE2, D_BYTE3, G_BYTE0, G_BYTE1, G_BYTE2, G_BYTE3]                                                                                                                                                                                                                                                                                                            |
| HAND_CMD_GET_FINGER_CURRENT_LIMIT |          0x05 | Get current limit of finger in mA                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, CURRENT_LIMIT_L, CURRENT_LIMIT_H]                                                                                                                                                                                                                                                                                                                                                                                                                          |
| HAND_CMD_GET_FINGER_CURRENT       |          0x06 | Get current of finger in mA                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, CURRENT_L, CURRENT_H]                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| HAND_CMD_GET_FINGER_FORCE_LIMIT   |          0x07 | Get force limit of finger in mN                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, FORCE_LIMIT_L, FORCE_LIMIT_H]                                                                                                                                                                                                                                                                                                                                                                                                                              |
| HAND_CMD_GET_FINGER_FORCE         |          0x08 | Get current force of finger in mN                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, FORCE_L, FORCE_H]                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| HAND_CMD_GET_FINGER_POS_LIMIT     |          0x09 | Get absolute pos limit of finger                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, POS_LIMIT_L, POS_LIMIT_H]                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| HAND_CMD_GET_FINGER_POS_ABS       |          0x0A | Get current absolute position of finger                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, ABS_TARGET_POS_L, ABS_TARGET_POS_H, ABSOLUTE_POS_L, ABSOLUTE_POS_H]                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_GET_FINGER_POS           |          0x0B | Get current logical position of finger                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, LOGICAL_TARGET_POS_L, LOGICAL_TARGET_POS_H, LOGICAL_POS_L, LOGICAL_POS_H]                                                                                                                                                                                                                                                                                                                                                                                  |
| HAND_CMD_GET_FINGER_ANGLE         |          0x0C | Get current angle of finger, value = angle * 100                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [FINGER_ID, TARGET_ANGLE_L, TARGET_ANGLE_H, CURRENT_ANGLE_L, CURRENT_ANGLE_H]                                                                                                                                                                                                                                                                                                                                                                                          |
| HAND_CMD_GET_THUMB_ROOT_POS       |          0x0D | Get preset position of thumb root, {0, 1, 2, 255}, 255 as unknown |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [PRESET_POS]                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| HAND_CMD_GET_SELF_TEST_SWITCH     |          0x20 | Get self-test on/off state, 0:OFF, 1:ON                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [ON_OFF]                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| HAND_CMD_GET_BEEP_SWITCH          |          0x21 | Get beep on/off state, 0:OFF, 1:ON                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [ON_OFF]                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| HAND_CMD_GET_BUTTON_PRESSED_CNT   |          0x22 | Get button pressed count, ignore for ROH please                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [BTN_PRESSED_CNT]                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| HAND_CMD_GET_UID                  |          0x23 | Get UID of hand                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [UID0_BYTE0, UID0_BYTE1, UID0_BYTE2, UID0_BYTE3, UID1_BYTE0, UID1_BYTE1, UID1_BYTE2, UID1_BYTE3, UID2_BYTE0, UID2_BYTE1, UID2_BYTE2, UID2_BYTE3]                                                                                                                                                                                                                                                                                                                       |
| HAND_CMD_GET_BATTERY_VOLTAGE      |          0x24 | Get battery voltage in mV, ignore for ROH please                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | [BATTERY_VOLTAGE_L, BATTERY_VOLTAGE_H]                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| HAND_CMD_GET_USAGE_STAT           |          0x25 | Get usage stats, ignore for ROH please                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_RESET                    |          0x40 | Reset to boot loader                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_POWER_OFF                |          0x41 | Power off, ignore for ROH please                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_NODE_ID              |          0x42 | Set hand node ID                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_CALIBRATE                |          0x43 | Calibrate hand, for factory use only                              | [KEY_L, KEY_H]                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_CALI_DATA            |          0x44 | Set calibration data                                              | [F0_RANGE_END_L, F0_RANGE_END_H, F1_RANGE_END_L, F1_RANGE_END_H, F2_RANGE_END_L, F2_RANGE_END_H, F3_RANGE_END_L, F3_RANGE_END_H, F4_RANGE_END_L, F4_RANGE_END_H, F0_RANGE_START_L, F0_RANGE_START_H, F1_RANGE_START_L, F1_RANGE_START_H, F2_RANGE_START_L, F2_RANGE_START_H, F3_RANGE_START_L, F3_RANGE_START_H, F4_RANGE_START_L, F4_RANGE_START_H, THUMB_ROOT_POS1_L, THUMB_ROOT_POS1_H, THUMB_ROOT_POS2_L, THUMB_ROOT_POS2_H, THUMB_ROOT_POS3_L, THUMB_ROOT_POS3_H] |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_FINGER_PID           |          0x45 | Set PID value for finger, PID values are all in float32           | [FINGER_ID, P_BYTE0, P_BYTE1, P_BYTE2, P_BYTE3, I_BYTE0, I_BYTE1, I_BYTE2, I_BYTE3, D_BYTE0, D_BYTE1, D_BYTE2, D_BYTE3, G_BYTE0, G_BYTE1, G_BYTE2, G_BYTE3]                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_FINGER_CURRENT_LIMIT |          0x46 | Set current limit for finger, [0, 65535]                          | [FINGER_ID, CURRENT_LIMIT_L, CURRENT_LIMIT_H]                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_FINGER_FORCE_LIMIT   |          0x47 | Set force limit for finger, [0, 65535]                            | [FINGER_ID, FORCE_LIMIT_L, FORCE_LIMIT_H]                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_FINGER_POS_LIMIT     |          0x48 | Set absolute pos limit for finger, [0, 65535]                     | [FINGER_ID, POS_LIMIT_L, POS_LIMIT_H]                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_FINGER_START             |          0x49 | Start finger                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_FINGER_STOP              |          0x4A | Stop finger                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_FINGER_POS_ABS       |          0x4B | Move finger to physical position, [0, 65535]                      | [FINGER_ID, ABSOLUTE_POS_L, ABSOLUTE_POS_H, SPEED]                                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_FINGER_POS           |          0x4C | Move finger to logical position, [0, 65535]                       | [FINGER_ID, LOGICAL_POS_L, LOGICAL_POS_H, SPEED]                                                                                                                                                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_FINGER_ANGLE         |          0x4D | Set angle of finger, [0, 65535], value = angle * 100              | [FINGER_ID, TARGET_ANGLE_L, TARGET_ANGLE_H, SPEED]                                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_THUMB_ROOT_POS       |          0x4E | Move thumb root to preset position, {0,1,2}                       | [PRESET_POS]                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_SELF_TEST_SWITCH     |          0x60 | Set self-test on/off state, 0:OFF, 1:ON                           | [ON_OFF]                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_BEEP_SWITCH          |          0x61 | Set beep on/off state, 0:OFF, 1:ON                                | [ON_OFF]                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_BEEP                     |          0x62 | Beep for a period in ms, [0, 65535]                               | [BEEP_PERIOD_L, BEEP_PERIOD_H]                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| HAND_CMD_SET_BUTTON_PRESSED_CNT   |          0x63 | Set button pressed count, ignore for ROH please                   | [BTN_PRESSED_CNT]                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |

注：

1. 如果不加说明，单字节数据为uint8类型，XXX_L, XXX_H表示uint16类型的低字节和高字节；XXX_BYTE0, XXX_BYTE1, XXX_BYTE2, XXX_BYTE3表示uint32类型自低到高4个字节；
2. 若指定为float32类型，XXX_BYTE0, XXX_BYTE1, XXX_BYTE2, XXX_BYTE3表示float32类型自低到高4个字节。

## 6. 灵巧手错误代码

| 错误名                         | 代码 | 说明         | 分组 |
| ------------------------------ | ---- | ------------ | ---- |
| ERR_PROTOCOL_WRONG_CRC         | 0x01 | 校验码错误   | 协议 |
| ERR_COMMAND_INVALID            | 0x11 | 无效的命令   | 命令 |
| ERR_COMMAND_INVALID_BYTE_COUNT | 0x12 | 字节数不正确 | 命令 |
| ERR_COMMAND_INVALID_DATA       | 0x13 | 无效的值     | 命令 |
| ERR_STATUS_INIT                | 0x21 | 正在初始化   | 状态 |
| ERR_STATUS_CALI                | 0x22 | 等待校正     | 状态 |
| ERR_STATUS_STUCK               | 0x23 | 电机堵转     | 状态 |
| ERR_OP_FAILED                  | 0x31 | 操作失败     | 操作 |
| ERR_SAVE_FAILED                | 0x32 | 保存失败     | 操作 |

## 7. 手指角度

待完成
